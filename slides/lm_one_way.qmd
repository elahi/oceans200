---
title: "Linear models: one-way designs"
author: "Robin Elahi"
subtitle: "Topics in Scientific and Statistical Computing"
format: revealjs
embed-resources: true
filters:
  - openlinksinnewpage
---

```{r setup, include=FALSE}
# Change general options
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, 
                      message = FALSE, warning = FALSE, 
                      cache = FALSE, par = FALSE)

# Set up figure options
knitr::opts_chunk$set(fig.align = 'center', fig.show = 'asis', 
                      fig.width = 4, fig.height = 3)

# Set the web address where R will look for files from this repository
repo_url <- "https://raw.githubusercontent.com/elahi/qk2e/master/data"

# Define the directory where images generated by knit will be saved
# knitr::opts_chunk$set(fig.path = "/images/", 
#                       cache.path = "/cache/")

# Packages
library(tidyverse)
library(knitr)
library(broom)
theme_set(theme_bw(base_size = 12) + theme(panel.grid = element_blank()))

# Set working directory
knitr::opts_knit$set(root.dir = "../")
```

## Outline

-   Intro to linear models (board)

-   Visualizing ANOVA (board)

-   R examples (slides)

## Examples from QK2E chapter 6

-   Box 6.1 (regression; continuous predictor)
    -   Discussion
-   Box 6.7 (ANOVA; categorical predictor)
    -   Discussion

## Box 6.1

Christensen et al. (1996) studied the relationships between coarse woody debris (CWD) and shoreline vegetation and lake development in a sample of 16 lakes in North America. The main variables of interest:

-   density of cabins (no. km^−1^)

-   **density of riparian trees (trees km^−1^)**

-   basal area of riparian trees (m^2^ km^−1^)

-   **density of coarse woody debris (no. km^−1^)**

-   basal area of coarse woody debris (m^2^ km^−1^)

## Visualize data

```{r}
#| echo: false
d <- read_csv("data/christ.csv")
d %>% 
  ggplot(aes(ripdens, cwdbasal)) + 
  geom_point() + 
  labs(x = "Riparian density (x 100)", y = "CWD basal area")
```

## Linear model

```{r}
m1 <- lm(cwdbasal ~ ripdens, data = d)
summary(m1)
```

## Plot predicted values vs residuals

```{r}
#| echo: false
d <- d %>% 
  mutate(resids = resid(m1), 
         fitted = fitted(m1))
d %>% ggplot(aes(fitted, resids)) + 
  geom_point() + 
  labs(x = "Predicted value", y = "Residual")
#plot(m1, which = 1)
```

## Discussion

-   Thoughts on the reading (6.1; continuous predictor)

-   This material is foundational. You've probably done a linear regression before. If you were teaching an undergrad, what is a key point you would emphasize?

## Box 6.7

Keough and Raimondi (1995) set up an experiment to examine the response of serpulid (polychaete worms) larvae to four types of biofilms on hard substrata in shallow marine waters. The four treatments were:

-   **F**: field substrata (with a net, to exclude other invertebrates)
-   **NL**: netted substrata developed in the lab
-   **UL**: un-netted substrata developed in the lab
-   **SL**: sterile substrata in the lab, without a net

## Visualize data

```{r}
#| echo: false
d <- read.csv("data/serpulid.csv") %>% 
  mutate(film = factor(film))
d %>% 
  ggplot(aes(film, lserp)) + 
  geom_boxplot() + 
  labs(x = "Film treatment", y = "Log(serpulid count)")
```

## Linear model

```{r}
m1 <- lm(lserp ~ film, data = d)
summary(m1)
```

## Set your reference level

```{r}
d <- d %>% mutate(film_ = fct_relevel(film, "SL", "UL", "NL", "F"))
glimpse(d$film); glimpse(d$film_)
```

```{r}
#| echo: false
d %>% 
  ggplot(aes(film_, lserp)) + 
  geom_boxplot() + 
  labs(x = "Film treatment", y = "Log(serpulid count)")
```

## Linear model, take 2

```{r}
m2 <- lm(lserp ~ film_, data = d)
summary(m2)
```

## Null model

```{r}
m0 <- lm(lserp ~ 1, data = d)
summary(m0)
```

## Comparing linear models

```{r}
anova(m0, m1)
```

. . .

```{r}
anova(m1)
```

## Planned contrasts

Define a linear combination of the *p* means that represent the comparison of interest

$$
    c_1 \bar{y}_1 + ... + c_i \bar{y}_i + c_p \bar{y}_p
$$

where $c_i$ represent contrast coefficients and sum to zero, and $\bar{y}_i$ are group means.

. . .

To omit a group, give it a coefficient of zero.

. . .

Very cool: you can do contrasts for polynomial trends with group means! (see Box 6.4)

## UL vs NL

```{r}
# Default
contrasts(d$film)
```

. . .

```{r}
# Change it
contrasts(d$film) <- c(0, 1, 0, -1)
contrasts(d$film)
```

## UL vs NL

```{r}
# Refit the model with new contrasts
serpulid.aov <- aov(lserp ~ film, data = d)
summary(serpulid.aov)
```

> Note that the `aov` results have not changed.

## UL vs NL

```{r}
tidy(summary.lm(serpulid.aov))
```

> To evaluate the contrast, look at the statistic and p-value for `film1`

## F vs average (NL & UL)

```{r}
contrasts(d$film) <- c(2,-1,0,-1)
contrasts(d$film)
```

. . .

```{r}
serpulid.aov <- aov(lserp ~ film, data = d)
tidy(summary.lm(serpulid.aov))
```

## SL vs average (F & NL & UL)

```{r}
contrasts(d$film) <- c(-1,-1,3,-1)
contrasts(d$film)
```

. . .

```{r}
serpulid.aov <- aov(lserp ~ film, data = d)
tidy(summary.lm(serpulid.aov))
```

## Discussion

-   Thoughts on the reading (6.2; categorical predictor)

-   This material is foundational. You've probably done a one-way ANOVA before. If you were teaching an undergrad, what is a key point you would emphasize?
